name: 🎫 Create Jira Ticket for Dependabot Security PRs

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  create-jira-ticket:
    runs-on: ubuntu-latest
    if: >
      github.actor == 'dependabot[bot]' &&
      contains(github.event.pull_request.title, 'Security')
    
    steps:
      - name: 🔍 Checkout repository
        uses: actions/checkout@v4
      
      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: 📦 Install dependencies
        run: npm ci --only=production
      
      - name: 🎫 Create Jira ticket
        id: create-ticket
        run: node scripts/create-jira-ticket.js
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_BODY: ${{ github.event.pull_request.body }}
      
      - name: 💬 Add comment to PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const ticketKey = '${{ steps.create-ticket.outputs.ticket_key }}';
            const ticketUrl = '${{ steps.create-ticket.outputs.ticket_url }}';
            
            const comment = `🎫 **Jira Ticket Created**
            
            A Jira ticket has been automatically created for this Dependabot security PR:
            
            **Ticket:** [${ticketKey}](${ticketUrl})
            
            This ticket tracks the security vulnerability and ensures proper review and resolution.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: 🏷️ Add security label to PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['security', 'dependabot']
            });
      
      - name: ❌ Handle failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `❌ **Failed to Create Jira Ticket**
            
            There was an error creating a Jira ticket for this Dependabot security PR.
            
            Please check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) and create a ticket manually if needed.
            
            **PR Details:**
            - Title: ${{ github.event.pull_request.title }}
            - URL: ${{ github.event.pull_request.html_url }}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });