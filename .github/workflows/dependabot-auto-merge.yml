name: ğŸ¤– Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: ğŸ” Get PR information
        id: pr-info
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"

          echo "ğŸ¤– Processing Dependabot PR #$PR_NUMBER"
          echo "ğŸ“‹ Title: $PR_TITLE"

          # Parse update type from title (patch/minor/major)
          if [[ "$PR_TITLE" =~ "bump" ]]; then
            if [[ "$PR_TITLE" =~ "patch" ]] || [[ "$PR_TITLE" =~ [0-9]+\.[0-9]+\.[0-9]+ ]]; then
              UPDATE_TYPE="patch"
            elif [[ "$PR_TITLE" =~ "minor" ]]; then
              UPDATE_TYPE="minor"
            elif [[ "$PR_TITLE" =~ "major" ]]; then
              UPDATE_TYPE="major"
            else
              UPDATE_TYPE="unknown"
            fi
          else
            UPDATE_TYPE="unknown"
          fi

          echo "update_type=$UPDATE_TYPE" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Update type: $UPDATE_TYPE"

      - name: ğŸ¤– Approve and enable auto-merge
        run: |
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"
          UPDATE_TYPE="${{ steps.pr-info.outputs.update_type }}"

          echo "âœ… Auto-approving Dependabot PR #$PR_NUMBER"

          # Approve the PR with detailed message
          APPROVAL_MESSAGE="ğŸ¤– **Auto-approved by Dependabot workflow**

          Update type: \`$UPDATE_TYPE\`

          Auto-merge has been enabled. The PR will merge automatically after all CI checks pass."

          gh pr review "$PR_NUMBER" --approve --body "$APPROVAL_MESSAGE" || {
            echo "âŒ Failed to approve PR"
            exit 1
          }

          echo "âœ… PR approved successfully"

          # Enable auto-merge (does NOT merge immediately - only enables it)
          # The PR will be merged automatically by GitHub once all required checks pass
          echo "ğŸ”„ Enabling auto-merge feature..."
          gh pr merge "$PR_NUMBER" --auto --squash || {
            echo "âŒ Failed to enable auto-merge"
            echo "âš ï¸ This might happen if:"
            echo "   - Auto-merge is not enabled in repository settings"
            echo "   - Required status checks are not configured"
            echo "   - PR has merge conflicts"
            exit 1
          }

          echo "ğŸš€ Auto-merge enabled successfully for PR #$PR_NUMBER"
          echo "ğŸ“‹ The PR will NOT merge immediately"
          echo "â³ GitHub will automatically merge it once all required checks pass"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: ğŸ“ Add status comment
        if: success()
        run: |
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"
          UPDATE_TYPE="${{ steps.pr-info.outputs.update_type }}"

          COMMENT="ğŸ¤– **Auto-merge enabled**

          This Dependabot PR has been automatically approved and configured for auto-merge.

          **Status:**
          - âœ… Automatically approved
          - ğŸ”„ Auto-merge enabled (squash merge)
          - ğŸ—‘ï¸ Branch will be deleted after merge
          - ğŸ“Š Update type: \`$UPDATE_TYPE\`

          **Next steps:**
          The PR will automatically merge once:
          - âœ… All CI/CD checks pass
          - âœ… Required status checks complete
          - âœ… No merge conflicts exist

          ğŸ’¡ **Note:** You can disable auto-merge or make changes from the PR page if needed."

          gh pr comment "$PR_NUMBER" --body "$COMMENT"
          echo "âœ… Status comment added"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: âš ï¸ Handle failure
        if: failure()
        run: |
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"

          echo "âŒ Auto-merge workflow failed for PR #$PR_NUMBER"

          COMMENT="âš ï¸ **Auto-merge setup failed**

          The Dependabot auto-merge workflow encountered an issue. Please check the workflow logs for details.

          **Possible reasons:**
          - Auto-merge not enabled in repository settings
          - Required status checks not configured
          - PR has merge conflicts
          - Permission issues

          You may need to manually review and merge this PR."

          gh pr comment "$PR_NUMBER" --body "$COMMENT" || echo "Failed to add error comment"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
