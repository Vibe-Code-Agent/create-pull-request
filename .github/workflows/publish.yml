name: ğŸš€ Publish to NPM

on:
  workflow_dispatch: # Allows manual triggering
    inputs:
      version_type:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
          - prerelease
      dry_run:
        description: "Run in dry-run mode (no actual publish)"
        required: false
        default: false
        type: boolean

jobs:
  publish:
    name: Publish Package
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    # Only run on main branch or tags
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')

    outputs:
      package_name: ${{ steps.package-info.outputs.package_name }}
      package_version: ${{ steps.package-info.outputs.package_version }}

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
          cache: "npm"

      - name: ğŸ“¦ Cache build and publish artifacts
        uses: actions/cache@v4
        with:
          path: |
            lib
            *.tsbuildinfo
            ~/.npm
            node_modules/.cache
            dist
          key: publish-${{ runner.os }}-${{ hashFiles('src/**/*', 'tsconfig.json', 'package-lock.json', 'package.json') }}
          restore-keys: |
            publish-${{ runner.os }}-
            build-${{ runner.os }}-

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“‹ Get package information
        id: package-info
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")

          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Package: $PACKAGE_NAME"
          echo "ğŸ·ï¸  Version: $PACKAGE_VERSION"

      - name: ğŸ” Check if version already exists
        run: |
          PACKAGE_NAME="${{ steps.package-info.outputs.package_name }}"
          PACKAGE_VERSION="${{ steps.package-info.outputs.package_version }}"

          echo "ğŸ” Checking if $PACKAGE_NAME@$PACKAGE_VERSION already exists on NPM..."

          if npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version > /dev/null 2>&1; then
            echo "âŒ Version $PACKAGE_VERSION already exists on NPM!"
            echo "ğŸ“‹ Please update the version in package.json before publishing"
            echo "ğŸ”— View on NPM: https://www.npmjs.com/package/$PACKAGE_NAME"
            exit 1
          else
            echo "âœ… Version $PACKAGE_VERSION is available for publishing"
          fi

      - name: ğŸ” Verify package integrity
        run: npm audit signatures

      - name: ğŸ§ª Run tests
        run: npm test

      - name: ğŸ“ Run linting
        run: npm run lint

      - name: ğŸ—ï¸ Build project
        run: npm run build

      - name: ğŸ” Validate build artifacts
        run: |
          # Check if build artifacts exist
          if [ ! -f "lib/index.js" ]; then
            echo "âŒ Build artifacts not found!"
            exit 1
          fi

          # Check if binary is executable
          if [ ! -x "bin/create-pr.js" ]; then
            echo "âŒ Binary is not executable!"
            exit 1
          fi

          echo "âœ… Build artifacts validated"

      - name: ğŸ”’ Security audit
        run: |
          echo "ğŸ”’ Running security audit..."
          if npm audit --audit-level=high; then
            echo "âœ… No high-severity vulnerabilities found"
          else
            echo "âš ï¸ Security vulnerabilities detected"
            echo "ğŸ“‹ Review the output above and consider fixing before publishing"
          fi
        continue-on-error: true

      - name: ğŸ·ï¸ Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/}
          PACKAGE_NAME="${{ steps.package-info.outputs.package_name }}"
          PACKAGE_VERSION="${{ steps.package-info.outputs.package_version }}"

          echo "ğŸ·ï¸ Creating GitHub release for $TAG_VERSION..."

          # Determine if prerelease
          PRERELEASE_FLAG=""
          if [[ "$TAG_VERSION" =~ - ]]; then
            PRERELEASE_FLAG="--prerelease"
            echo "ğŸ“‹ Creating prerelease"
          fi

          gh release create "$TAG_VERSION" \
            --title "Release $TAG_VERSION" \
            --notes "## ğŸš€ What's New in $TAG_VERSION

          ### Changes
          - Auto-generated release from version tag
          - See commit history for detailed changes

          ### Installation
          \`\`\`bash
          npm install -g $PACKAGE_NAME@$PACKAGE_VERSION
          \`\`\`

          ### Usage
          \`\`\`bash
          create-pr create --jira YOUR-123
          \`\`\`

          For full documentation, see [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)" \
            $PRERELEASE_FLAG

          echo "âœ… GitHub release created"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: ğŸ§ª NPM Publish (Dry Run)
        if: github.event.inputs.dry_run == 'true'
        run: |
          PACKAGE_NAME="${{ steps.package-info.outputs.package_name }}"
          PACKAGE_VERSION="${{ steps.package-info.outputs.package_version }}"

          echo "ğŸ§ª Running in dry-run mode - no actual publish"
          echo "ğŸ“¦ Would publish: $PACKAGE_NAME@$PACKAGE_VERSION"
          echo ""

          npm publish --dry-run

          echo ""
          echo "âœ… Dry run completed successfully"
          echo "ğŸ’¡ Remove --dry-run to actually publish"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ğŸš€ Publish to NPM
        if: github.event.inputs.dry_run != 'true'
        run: |
          PACKAGE_NAME="${{ steps.package-info.outputs.package_name }}"
          PACKAGE_VERSION="${{ steps.package-info.outputs.package_version }}"

          echo "ğŸš€ Publishing to NPM..."
          echo "ğŸ“¦ Package: $PACKAGE_NAME@$PACKAGE_VERSION"
          echo ""

          # Publish to NPM
          npm publish --access public

          echo ""
          echo "âœ… Successfully published $PACKAGE_NAME@$PACKAGE_VERSION"
          echo "ğŸ“¦ Install with: npm install -g $PACKAGE_NAME@$PACKAGE_VERSION"
          echo "ğŸ”— View on NPM: https://www.npmjs.com/package/$PACKAGE_NAME"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ğŸ“Š Post-publish validation
        if: github.event.inputs.dry_run != 'true'
        run: |
          PACKAGE_NAME="${{ steps.package-info.outputs.package_name }}"
          PACKAGE_VERSION="${{ steps.package-info.outputs.package_version }}"

          echo "â³ Polling NPM registry for package availability..."
          echo "ğŸ“¦ Package: $PACKAGE_NAME@$PACKAGE_VERSION"

          # Polling configuration
          MAX_ATTEMPTS=20
          POLL_INTERVAL=5
          ATTEMPT=0
          PACKAGE_AVAILABLE=false

          # Poll until package is available or max attempts reached
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            ELAPSED_TIME=$((ATTEMPT * POLL_INTERVAL))
            
            echo "ğŸ“Š Attempt $ATTEMPT/$MAX_ATTEMPTS (${ELAPSED_TIME}s elapsed) - Checking package availability..."
            
            # Try to fetch package info from npm
            if npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version > /dev/null 2>&1; then
              echo "âœ… Package is now available on NPM registry!"
              echo "â±ï¸  Package became available after ${ELAPSED_TIME} seconds"
              PACKAGE_AVAILABLE=true
              break
            else
              echo "   â³ Package not yet available, waiting ${POLL_INTERVAL}s..."
              
              # Don't sleep on the last attempt
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                sleep $POLL_INTERVAL
              fi
            fi
          done

          # Final status
          if [ "$PACKAGE_AVAILABLE" = true ]; then
            echo ""
            echo "ğŸ‰ Validation successful!"
            echo "ğŸ”— NPM: https://www.npmjs.com/package/$PACKAGE_NAME/v/$PACKAGE_VERSION"
          else
            echo ""
            echo "âš ï¸ Package not detected after $((MAX_ATTEMPTS * POLL_INTERVAL)) seconds"
            echo "ğŸ“‹ This doesn't mean publishing failed - NPM sync can take longer"
            echo "ğŸ” Manually verify: npm view $PACKAGE_NAME@$PACKAGE_VERSION"
            echo "ğŸ”— NPM: https://www.npmjs.com/package/$PACKAGE_NAME"
          fi

      - name: ğŸ’¬ Success notification
        if: success()
        run: |
          PACKAGE_NAME="${{ steps.package-info.outputs.package_name }}"
          PACKAGE_VERSION="${{ steps.package-info.outputs.package_version }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"

          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸ‰ DRY RUN COMPLETED!"
            echo ""
            echo "ğŸ“¦ Package: $PACKAGE_NAME@$PACKAGE_VERSION"
            echo "âœ… All checks passed - ready for publishing"
            echo ""
            echo "ğŸ’¡ To actually publish, run without --dry-run flag"
          else
            echo "ğŸ‰ SUCCESS! Package published successfully"
            echo ""
            echo "ğŸ“¦ Package: $PACKAGE_NAME@$PACKAGE_VERSION"
            echo "ğŸ”— NPM: https://www.npmjs.com/package/$PACKAGE_NAME"
            echo "ğŸ“š GitHub: https://github.com/${{ github.repository }}"
            echo ""
            echo "ğŸš€ Users can now install with:"
            echo "   npm install -g $PACKAGE_NAME@$PACKAGE_VERSION"
          fi

  # Notify on failure
  notify_failure:
    name: Failure Notification
    runs-on: ubuntu-latest
    needs: publish
    if: failure()

    steps:
      - name: ğŸš¨ Failure notification
        run: |
          echo "âŒ Publishing workflow failed!"
          echo ""
          echo "ğŸ“‹ Please check the logs above for details."
          echo ""
          echo "ğŸ” Common issues:"
          echo ""
          echo "1. **NPM_TOKEN not configured**"
          echo "   - Check that NPM_TOKEN secret is set in repository settings"
          echo "   - Ensure the token has publish permissions"
          echo ""
          echo "2. **Version already exists**"
          echo "   - The version in package.json already exists on NPM"
          echo "   - Update the version before publishing"
          echo ""
          echo "3. **Tests or linting failures**"
          echo "   - Fix any failing tests or lint errors"
          echo "   - Run 'npm test' and 'npm run lint' locally"
          echo ""
          echo "4. **Build errors**"
          echo "   - Ensure 'npm run build' completes successfully"
          echo "   - Check TypeScript compilation errors"
          echo ""
          echo "5. **Package integrity issues**"
          echo "   - Review npm audit results"
          echo "   - Fix security vulnerabilities if needed"
          echo ""
          echo "ğŸ’¡ For more help, check the workflow logs or contact the maintainers"
